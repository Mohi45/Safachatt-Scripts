<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin - Java Syllabus Tracker Dashboard</title>
    <link rel="stylesheet" href="../css/adminSyllabus.css">
</head>

<body>
    <!-- Header -->
    <header class="site-header">
        <div class="container header-container">
            <div class="logo-container">
                <img src="../images/logo.jpg" class="logo-img" alt="Logo">
                <a href="../courses/codingQuestions.html" class="logo-text">Safachatt Scripts</a>
            </div>
            <div class="site-title-description">
                <h1>ðŸ“˜ Admin Dashboard - Java Syllabus Tracker</h1>
                <p>Monitor user submissions & progress</p>
            </div>
        </div>
    </header>

    <div class="top-controls">
        <input type="text" id="searchUser" placeholder="Search user by name/email..." oninput="filterUsers()" />
        <div><b>Total Users:</b> <span id="totalUsers">0</span></div>
    </div>

    <div class="container">
        <table>
            <thead>
                <tr>
                    <th>#</th>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Completed Days</th>
                    <th>Progress %</th>
                    <th>Last Completed Day</th>
                    <th>View Details</th>
                </tr>
            </thead>
            <tbody id="usersTable"></tbody>
        </table>
    </div>

    <!-- MODAL -->
    <div id="detailsModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle">User Details</h2>
            <button class="btn btn-close" onclick="closeModal()">Close</button>

            <div class="container" style="margin-top:15px;">
                <table>
                    <thead>
                        <tr>
                            <th>Day</th>
                            <th>Theory</th>
                            <th>Program</th>
                            <th>Homework</th>
                            <th>Completed</th>
                        </tr>
                    </thead>
                    <tbody id="detailsTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDelVJHim-GKlaU2c-y7iTSiO7qy2fdZWI",
            authDomain: "syllabus-77df7.firebaseapp.com",
            projectId: "syllabus-77df7",
            storageBucket: "syllabus-77df7.firebasestorage.app",
            messagingSenderId: "119110461291",
            appId: "1:119110461291:web:d6be3fc68ae09dd18c0e2e"
        };

        const ADMIN_EMAIL = "mk908990@gmail.com";
        const TOTAL_DAYS = 60;

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let usersData = [];

        function yesNo(val) {
            return val === true
                ? `<span class="status-yes">âœ”</span>`
                : `<span class="status-no">âœ˜</span>`;
        }

        async function loadAllUsers() {
            const snap = await getDocs(collection(db, "javaPlanUsers"));
            usersData = [];

            snap.forEach(docSnap => {
                const data = docSnap.data();
                const uid = docSnap.id;

                let completedDays = 0;
                let lastCompletedDay = 0;

                for (let day = 1; day <= TOTAL_DAYS; day++) {
                    if (data[`day${day}_completed`] === true) {
                        completedDays++;
                        lastCompletedDay = day;
                    }
                }

                const progressPercent = Math.round((completedDays / TOTAL_DAYS) * 100);

                usersData.push({
                    uid,
                    name: data.name || "No Name",
                    email: data.email || "No Email",
                    completedDays,
                    progressPercent,
                    lastCompletedDay
                });
            });

            document.getElementById("totalUsers").innerText = usersData.length;
            renderUsersTable(usersData);
        }

        function renderUsersTable(list) {
            const tbody = document.getElementById("usersTable");
            tbody.innerHTML = "";

            list.forEach((user, index) => {
                const tr = document.createElement("tr");

                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td><b>${user.name}</b></td>
                    <td>${user.email}</td>
                    <td>${user.completedDays} / ${TOTAL_DAYS}</td>
                    <td class="${user.progressPercent >= 50 ? "progress-green" : "progress-red"}">
                        ${user.progressPercent}%
                    </td>
                    <td>Day ${user.lastCompletedDay}</td>
                    <td>
                        <button class="btn btn-view" onclick="viewDetails('${user.uid}', '${user.email}')">
                            View
                        </button>
                    </td>
                `;

                tbody.appendChild(tr);
            });
        }

        window.filterUsers = function () {
            const keyword = document.getElementById("searchUser").value.toLowerCase();

            const filtered = usersData.filter(u =>
                u.name.toLowerCase().includes(keyword) ||
                u.email.toLowerCase().includes(keyword)
            );

            renderUsersTable(filtered);
        };

        window.viewDetails = async function (uid, email) {
            const docRef = doc(db, "javaPlanUsers", uid);
            const docSnap = await getDoc(docRef);

            if (!docSnap.exists()) {
                alert("No data found for this user!");
                return;
            }

            const data = docSnap.data();

            document.getElementById("modalTitle").innerText =
                `ðŸ“Œ User Details: ${email}`;

            const tbody = document.getElementById("detailsTable");
            tbody.innerHTML = "";

            for (let day = 1; day <= TOTAL_DAYS; day++) {
                const theory = data[`day${day}_theory`] || false;
                const program = data[`day${day}_program`] || false;
                const homework = data[`day${day}_homework`] || false;
                const completed = data[`day${day}_completed`] || false;

                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td><b>Day ${day}</b></td>
                    <td>${yesNo(theory)}</td>
                    <td>${yesNo(program)}</td>
                    <td>${yesNo(homework)}</td>
                    <td>${yesNo(completed)}</td>
                `;

                tbody.appendChild(tr);
            }

            document.getElementById("detailsModal").style.display = "block";
        };

        window.closeModal = function () {
            document.getElementById("detailsModal").style.display = "none";
        };

        // AUTH CHECK
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                alert("Admin not logged in. Please login first.");
                window.location.href = "index.html";
                return;
            }

            if (user.email !== ADMIN_EMAIL) {
                alert("Access Denied! Not Admin.");
                return;
            }

            loadAllUsers();
        });

    </script>

</body>

</html>